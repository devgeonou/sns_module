variables {
  region                      = "eu-west-1"
  topic_name                  = "sns-example-standard"
  fifo_topic                  = false
  content_based_deduplication = false
  display_name                = "Standard Topic Example"
  signature_version           = "1"
  tracing_config              = "PassThrough"

  tags = {
    "Project" = "terraform-aws-sns-standard"
  }

  subscriptions = {
    "sqs_subscription" = {
      endpoint : "arn:aws:sqs:eu-west-1:123456789012:example-queue",
      protocol : "sqs",
      create : true,
      confirmation_timeout_in_minutes : 1,
    }
  }
  
enable_data_protection_policy = true
data_protection_policy = jsonencode(

    {
      Description = "Deny Inbound Address"
      Name        = "DenyInboundEmailAdressPolicy"
      Statement = [
        {
          "DataDirection" = "Inbound"
          "DataIdentifier" = [
            "arn:aws:dataprotection::aws:data-identifier/EmailAddress",
          ]
          "Operation" = {
            "Deny" = {}
          }
          "Principal" = [
            "*",
          ]
          "Sid" = "DenyInboundEmailAddress"
        },
      ]
      Version = "2021-06-01"
    }
  )

}


provider "aws" {
  region = var.region
}

run "verify_sns_topic_configuration" {
  command = plan

  assert {
    condition     = var.topic_name != null
    error_message = "Topic name should be set."
  }

  assert {
    condition     = contains(keys(var.tags), "Project") && var.tags["Project"] == "terraform-aws-sns-standard"
    error_message = "The 'Project' tag with the value 'terraform-aws-sns-standard' must be present."
  }

  assert {
    condition     = var.subscriptions != null
    error_message = "Add at least one subscription."
  }

  assert {
    condition     = var.fifo_topic == false
    error_message = "FIFO topic configuration does not match expected value."
  }

  assert {
    condition     = var.tracing_config == "Active" || var.tracing_config == "PassThrough"
    error_message = "TracingConfig must be set to either 'Active' or 'PassThrough'."
  }
  
  assert {
    condition     = var.enable_data_protection_policy
    error_message = "Data Protection Policy should be enabled for the SNS topic."
  }

  assert {
    condition     = length(var.data_protection_policy) > 0
    error_message = "A valid Data Protection Policy must be provided."
  }

  assert {
    condition     = (var.enable_data_protection_policy && var.data_protection_policy != null && !var.fifo_topic) || (!var.enable_data_protection_policy && var.fifo_topic)
    error_message = "Data protection policy should be applied only when enabled, not null, and FIFO topic is false."
  }
}
