variables {
  region                      = "eu-west-1"
  topic_name                  = "sns-example-fifo" # FIFO topic names must end with '.fifo'
  fifo_topic                  = true
  content_based_deduplication = true # Important for FIFO topics
  display_name                = "FIFO Topic Example"
  signature_version           = "1" # Assuming default, adjust as needed
  tracing_config              = "PassThrough" # FIFO topics typically don't support 'Active' tracing

  tags = {
    "Project" = "terraform-aws-sns-fifo"
  }

  subscriptions = {
    "sqs_subscription" = {
      endpoint : "arn:aws:sqs:eu-west-1:123456789012:example-fifo-queue",
      protocol : "sqs",
      create : true,
      confirmation_timeout_in_minutes : 1,
    }
  }

  enable_data_protection_policy = false # Assuming not required for this example, adjust as needed
}

provider "aws" {
  region = var.region
}

run "verify_sns_topic_configuration" {
  command = plan

  assert {
    condition     = contains(keys(var.tags), "Project") && var.tags["Project"] == "terraform-aws-sns-fifo"
    error_message = "The 'Project' tag with the value 'terraform-aws-sns-fifo' must be present."
  }

  assert {
    condition     = var.subscriptions != null
    error_message = "Add at least one subscription."
  }

  assert {
    condition     = var.fifo_topic == true
    error_message = "FIFO topic configuration must be enabled."
  }

  assert {
    condition     = var.content_based_deduplication == true
    error_message = "Content-based deduplication must be enabled for FIFO topics."
  }

  assert {
    condition     = !var.enable_data_protection_policy || (var.enable_data_protection_policy && var.data_protection_policy != null)
    error_message = "Data protection policy should be correctly configured for FIFO topics if enabled."
  }
}
